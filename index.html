<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Animation Page</title>
    <script src="https://cdn.jsdelivr.net/npm/@javascript/danfojs@0.5.2/lib/bundle.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>CPI data</h1>
    <table id="CpiTable">
        <thead>
            <tr>
                <th>Perioden</th>
                <th>CPI_1</th> <!--Consumentenprijsindex alle huishoudens 2015 = 100 -->
                <th>JaarmutatieCPI_5</th> <!--Procentuele mutatie van de CPI t.o.v. dezelfde periode een jaar eerder-->
            </tr>
        </thead>
        <tbody></tbody>
    </table>
<p>testing</p>
    <h1>lolol</h1>
    <table id="XXTable">
        <thead>
            <tr>
                <th>Perioden</th>
                <th>CPI_1</th> <!--Consumentenprijsindex alle huishoudens 2015 = 100 -->
                <th>JaarmutatieCPI_5</th> <!--Procentuele mutatie van de CPI t.o.v. dezelfde periode een jaar eerder-->
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script>
        const CPI_metadata = {
            "odata.metadata": "https://opendata.cbs.nl/ODataApi/OData/83131NED/$metadata",
            "value": [
                { "name": "TableInfos", "url": "https://opendata.cbs.nl/ODataApi/odata/83131NED/TableInfos" },
                { "name": "UntypedDataSet", "url": "https://opendata.cbs.nl/ODataApi/odata/83131NED/UntypedDataSet" },
                { "name": "TypedDataSet", "url": "https://opendata.cbs.nl/ODataApi/odata/83131NED/TypedDataSet" },
                { "name": "DataProperties", "url": "https://opendata.cbs.nl/ODataApi/odata/83131NED/DataProperties" },
                { "name": "CategoryGroups", "url": "https://opendata.cbs.nl/ODataApi/odata/83131NED/CategoryGroups" },
                { "name": "Bestedingscategorieen", "url": "https://opendata.cbs.nl/ODataApi/odata/83131NED/Bestedingscategorieen" },
                { "name": "Perioden", "url": "https://opendata.cbs.nl/ODataApi/odata/83131NED/Perioden" }
            ]
        };

        const PPI_metadata = {
            "odata.metadata": "https://opendata.cbs.nl/ODataApi/OData/85771NED/$metadata",
            "value": [
                { "name": "TableInfos", "url": "https://opendata.cbs.nl/ODataApi/odata/85771NED/TableInfos" },
                { "name": "UntypedDataSet", "url": "https://opendata.cbs.nl/ODataApi/odata/85771NED/UntypedDataSet" },
                { "name": "TypedDataSet", "url": "https://opendata.cbs.nl/ODataApi/odata/85771NED/TypedDataSet" },
                { "name": "DataProperties", "url": "https://opendata.cbs.nl/ODataApi/odata/85771NED/DataProperties" },
                { "name": "CategoryGroups", "url": "https://opendata.cbs.nl/ODataApi/odata/85771NED/CategoryGroups" },
                { "name": "Afzet", "url": "https://opendata.cbs.nl/ODataApi/odata/85771NED/Afzet" },
                { "name": "AlleBedrijfstakken", "url": "https://opendata.cbs.nl/ODataApi/odata/85771NED/AlleBedrijfstakken" },
                { "name": "Perioden", "url": "https://opendata.cbs.nl/ODataApi/odata/85771NED/Perioden" }
            ]
        };

        // // Function to list available entities
        // function listAvailableEntities(metadata) {
        //     console.log("Available Entities:");
        //     metadata.value.forEach(entity => {
        //         console.log(`Entity Name: ${entity.name}, URL: ${entity.url}`);
        //     });
        // }

        function getTypedDataSetUrl(years, category, metadata) {
            // Create a dynamic filter based on the years provided
            const yearFilters = years.map(year => `substringof('${year}', Perioden)`).join(' or ');
            const categoryFilter = `Bestedingscategorieen eq '${category}'`;
            const filter = `${yearFilters} and ${categoryFilter}`;
            // Construct the final URL
            const typedDataSetUrl = metadata.value.find(entity => entity.name === 'TypedDataSet').url + 
                `?$filter=${filter}&$orderby=Perioden`; // Change ordering and top values as needed
            return typedDataSetUrl;
        }





        // Function to populate table with filtered data
        function populateTable(data, tableName) {
            const tableBody = document.querySelector(`#${tableName} tbody`);
            // Clear the existing table rows
            tableBody.innerHTML = '';

            // Loop through each item and create a row with the required columns
            data.forEach(item => {
                const row = document.createElement("tr");
                // Create cells for each column
                const periodCell = document.createElement("td");
                periodCell.textContent = item.Perioden;
                row.appendChild(periodCell);

                const cpiCell = document.createElement("td");
                cpiCell.textContent = item.CPI_1;
                row.appendChild(cpiCell);

                const jaarmutatieCell = document.createElement("td");
                jaarmutatieCell.textContent = item.JaarmutatieCPI_5;
                row.appendChild(jaarmutatieCell);

                // Append the row to the table body
                tableBody.appendChild(row);
            });
        }

        // Fetch data from TypedDataSet
        async function fetchTypedDataSet(years, category) {
            const typedDataSetUrl = getTypedDataSetUrl(years, category, CPI_metadata);
            // console.log('Fetching Data from URL:', typedDataSetUrl); // Log the URL being fetched
            try {
                const response = await fetch(typedDataSetUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                // Filter out entries where Perioden ends with "00"
                const filteredData = data.value.filter(item => !item.Perioden.endsWith('00')).reverse();       
                console.log('Fetched Data:', JSON.stringify(filteredData, null, 2)); // Log the fetched data

                // Populate the table with filtered data
                populateTable(filteredData, "CpiTable");

            } catch (error) {
                console.error('Error fetching TypedDataSet:', error);
                }
        }

        // Example usage
        fetchTypedDataSet(['2024', '2023'], 'T001112  '); 







    </script>
</body>
</html>
